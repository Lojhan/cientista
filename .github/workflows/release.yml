name: Automated Release

on:
  # Trigger on PRs to main with release branches
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened, labeled]
  
  # Trigger on merge to main
  push:
    branches: [main, master]
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.2.3)'
        required: false
        type: string
      prerelease:
        description: 'Create prerelease'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # Detect version from PR branch or commit
  detect-version:
    name: Detect Version
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    outputs:
      should-release: ${{ steps.check.outputs.should-release }}
      version: ${{ steps.version.outputs.version }}
      version-type: ${{ steps.version.outputs.type }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if should release
        id: check
        run: |
          should_release="false"
          
          # Check if manual workflow dispatch
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            should_release="true"
          fi
          
          # Check if PR has release label or branch name
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Check for release labels
            if echo '${{ toJson(github.event.pull_request.labels.*.name) }}' | grep -q "release"; then
              should_release="true"
            fi
            
            # Check for release/* branch pattern
            if [[ "${{ github.head_ref }}" =~ ^release/ ]]; then
              should_release="true"
            fi
          fi
          
          # Check if push to main has version bump in commit
          if [[ "${{ github.event_name }}" == "push" ]]; then
            if git log -1 --pretty=%B | grep -Eq "(release|version|bump|chore\(release\))"; then
              should_release="true"
            fi
          fi
          
          echo "should-release=$should_release" >> $GITHUB_OUTPUT

      - name: Extract or determine version
        id: version
        if: steps.check.outputs.should-release == 'true'
        run: |
          VERSION=""
          TYPE="patch"
          IS_PRERELEASE="false"
          
          # Manual workflow dispatch
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ inputs.version }}" ]]; then
            VERSION="${{ inputs.version }}"
            if [[ "${{ inputs.prerelease }}" == "true" ]]; then
              IS_PRERELEASE="true"
            fi
          # Extract from branch name (release/1.2.3 or release/v1.2.3)
          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.head_ref }}" =~ ^release/ ]]; then
            VERSION=$(echo "${{ github.head_ref }}" | sed -E 's/^release\/(v)?([0-9]+\.[0-9]+\.[0-9]+).*$/\2/')
            IS_PRERELEASE="true"  # PRs create release candidates
          # For push events, use version from package.json (already updated in PR)
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            VERSION=$(node -p "require('./package.json').version")
            echo "Using version from package.json: $VERSION"
          # Check commit message for semver keywords (fallback)
          elif git log -1 --pretty=%B | grep -qi "major"; then
            TYPE="major"
          elif git log -1 --pretty=%B | grep -qi "minor"; then
            TYPE="minor"
          else
            TYPE="patch"
          fi
          
          # If no version specified, calculate from current version
          if [[ -z "$VERSION" ]]; then
            CURRENT_VERSION=$(node -p "require('./package.json').version")
            IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
            
            case "$TYPE" in
              major)
                VERSION="$((VERSION_PARTS[0] + 1)).0.0"
                ;;
              minor)
                VERSION="${VERSION_PARTS[0]}.$((VERSION_PARTS[1] + 1)).0"
                ;;
              patch)
                VERSION="${VERSION_PARTS[0]}.${VERSION_PARTS[1]}.$((VERSION_PARTS[2] + 1))"
                ;;
            esac
          fi
          
          # For PRs, append RC identifier
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            IS_PRERELEASE="true"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            SHA_SHORT=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
            VERSION="${VERSION}-rc.${PR_NUMBER}.${SHA_SHORT}"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Detected version: $VERSION (type: $TYPE, prerelease: $IS_PRERELEASE)"

  # Create release candidate for PRs
  release-candidate:
    name: Create Release Candidate
    runs-on: ubuntu-latest
    needs: detect-version
    if: |
      github.event_name == 'pull_request' && 
      needs.detect-version.outputs.should-release == 'true' &&
      needs.detect-version.outputs.is-prerelease == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Update version in package.json
        run: |
          npm version ${{ needs.detect-version.outputs.version }} --no-git-tag-version

      - name: Build project
        run: npm run build

      - name: Create GitHub prerelease
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.detect-version.outputs.version }}
          release_name: ${{ needs.detect-version.outputs.version }}
          body: |
            ðŸš§ **Release Candidate**
            
            This is a pre-release version created from PR #${{ github.event.pull_request.number }}
            
            **Changes in this PR:**
            ${{ github.event.pull_request.body }}
            
            **Commit:** ${{ github.event.pull_request.head.sha }}
            
            âš ï¸ This is a release candidate and should not be used in production.
          draft: false
          prerelease: true

      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ Release candidate **${{ needs.detect-version.outputs.version }}** has been created!\n\n` +
                    `This version will be published as a stable release when this PR is merged to main.`
            })

  # Create final release on merge to main
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: detect-version
    if: |
      github.event_name == 'push' && 
      needs.detect-version.outputs.should-release == 'true' &&
      needs.detect-version.outputs.is-prerelease == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build project
        run: npm run build

      - name: Check if version already updated
        id: version-check
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TARGET_VERSION="${{ needs.detect-version.outputs.version }}"
          
          if [[ "$PACKAGE_VERSION" == "$TARGET_VERSION" ]]; then
            echo "needs-update=false" >> $GITHUB_OUTPUT
            echo "Version already at $TARGET_VERSION"
          else
            echo "needs-update=true" >> $GITHUB_OUTPUT
            echo "Version needs update from $PACKAGE_VERSION to $TARGET_VERSION"
          fi

      - name: Update version and create tag
        if: steps.version-check.outputs.needs-update == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          npm version ${{ needs.detect-version.outputs.version }} --no-git-tag-version -m "chore(release): bump version to %s"
          git add package.json package-lock.json
          git commit -m "chore(release): bump version to ${{ needs.detect-version.outputs.version }}"
          git tag -a "${{ needs.detect-version.outputs.version }}" -m "Release ${{ needs.detect-version.outputs.version }}"
          git push
          git push --tags

      - name: Create tag only (version already updated)
        if: steps.version-check.outputs.needs-update == 'false'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git tag -a "${{ needs.detect-version.outputs.version }}" -m "Release ${{ needs.detect-version.outputs.version }}"
          git push --tags

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [[ -z "$LAST_TAG" ]]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.detect-version.outputs.version }}
          release_name: ${{ needs.detect-version.outputs.version }}
          body: |
            ## ðŸŽ‰ Release ${{ needs.detect-version.outputs.version }}
            
            ### Changes
            ${{ steps.changelog.outputs.changelog }}
            
            ### Installation
            \`\`\`bash
            npm install cientista@${{ needs.detect-version.outputs.version }}
            \`\`\`
          draft: false
          prerelease: false

      - name: Create summary
        run: |
          echo "### ðŸŽ‰ Release ${{ needs.detect-version.outputs.version }} Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.detect-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ needs.detect-version.outputs.version-type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The new version has been pushed and tagged." >> $GITHUB_STEP_SUMMARY
